

cmake_minimum_required(VERSION 3.13.0)
project(dms-client C)

set(CMAKE_C_STANDARD 99)
set(CMAKE_C_STANDARD_REQUIRED ON)

# AWS IoT SDK è·¯å¾‘ - é€é Makefile åƒæ•¸å‚³é (ä¿æŒå®Œå…¨ä¸è®Š)
if(NOT DEFINED AWS_IOT_SDK_ROOT)
    message(FATAL_ERROR "AWS_IOT_SDK_ROOT not defined. Please specify -DAWS_IOT_SDK_ROOT=<path>")
endif()

message(STATUS "Using AWS IoT SDK from: ${AWS_IOT_SDK_ROOT}")

# æª¢æŸ¥ SDK è·¯å¾‘æ˜¯å¦å­˜åœ¨
if(NOT EXISTS ${AWS_IOT_SDK_ROOT})
    message(FATAL_ERROR "AWS IoT SDK path does not exist: ${AWS_IOT_SDK_ROOT}")
endif()

# === BCML è·¯å¾‘é…ç½® (å®Œå…¨æ¨¡ä»¿ AWS IoT æ–¹å¼) ===
if(DEFINED BCML_ROOT)
    message(STATUS "Using BCML from: ${BCML_ROOT}")

    # æª¢æŸ¥ BCML è·¯å¾‘æ˜¯å¦å­˜åœ¨
    if(EXISTS ${BCML_ROOT})
        message(STATUS "âœ… BCML Middleware found at: ${BCML_ROOT}")
        set(BCML_ENABLED TRUE)
        add_definitions(-DBCML_MIDDLEWARE_ENABLED)
        add_definitions(-DUCI_API_ENABLE)

        # å°‹æ‰¾ BCML éœæ…‹åº« (æ ¹æ“šæ‚¨æä¾›çš„è·¯å¾‘çµæ§‹)
        set(BCML_LIB_PATHS
            "${BCML_ROOT}/libbcml.a"
            "${BCML_ROOT}/ipkg-install/usr/lib/libbcml.a"
            "${BCML_ROOT}/.pkgdir/bcml/usr/lib/libbcml.a"
            "${BCML_ROOT}/ipkg-aarch64_cortex-a53/bcml/usr/lib/libbcml.a"
        )

        set(BCML_LIB "")
        foreach(LIB_PATH ${BCML_LIB_PATHS})
            if(EXISTS ${LIB_PATH})
                set(BCML_LIB ${LIB_PATH})
                message(STATUS "âœ… BCML library found: ${BCML_LIB}")
                break()
            endif()
        endforeach()

        if(NOT BCML_LIB)
            message(WARNING "âš ï¸  BCML library not found, disabling BCML support")
            set(BCML_ENABLED FALSE)
        endif()
    else()
        message(WARNING "âš ï¸  BCML path does not exist: ${BCML_ROOT}, disabling BCML support")
        set(BCML_ENABLED FALSE)
    endif()
else()
    message(STATUS "BCML_ROOT not defined, compiling without BCML support")
    set(BCML_ENABLED FALSE)
endif()

# åŒ…å«ç›®éŒ„ (ä¿æŒ AWS IoT å®Œå…¨ä¸è®Šï¼Œæ¢ä»¶æ€§åŠ å…¥ BCML)
set(INCLUDE_DIRS
    ${AWS_IOT_SDK_ROOT}/source/include
    ${AWS_IOT_SDK_ROOT}/libraries/standard/coreMQTT/source/include
    ${AWS_IOT_SDK_ROOT}/libraries/standard/coreMQTT/source/interface
    ${AWS_IOT_SDK_ROOT}/libraries/standard/coreJSON/source/include
    ${AWS_IOT_SDK_ROOT}/platform/include
    ${AWS_IOT_SDK_ROOT}/platform/posix/transport/include
    ${AWS_IOT_SDK_ROOT}/platform/posix/clock/include
    ${AWS_IOT_SDK_ROOT}/demos/logging-stack
    ${AWS_IOT_SDK_ROOT}/demos/mqtt/mqtt_demo_mutual_auth
    src
)

# å¦‚æœ BCML å•Ÿç”¨ï¼ŒåŠ å…¥ BCML åŒ…å«ç›®éŒ„
if(BCML_ENABLED)
    list(APPEND INCLUDE_DIRS
        ${BCML_ROOT}/src/include
        ${BCML_ROOT}/src/lib/core
    )
endif()

include_directories(${INCLUDE_DIRS})

# AWS IoT SDK æºæ–‡ä»¶ - æ ¹æ“š mqtt_demo_mutual_auth.c åƒè€ƒä¿®æ­£è·¯å¾‘ (ä¿æŒå®Œå…¨ä¸è®Š)
# æª¢æŸ¥ä¸¦åˆ—å‡ºå¯¦éš›æ‰¾åˆ°çš„æ–‡ä»¶
file(GLOB CORE_MQTT_SOURCES
    "${AWS_IOT_SDK_ROOT}/libraries/standard/coreMQTT/source/*.c"
)

file(GLOB CORE_JSON_SOURCES
    "${AWS_IOT_SDK_ROOT}/libraries/standard/coreJSON/source/*.c"
)

# ä¹Ÿå˜—è©¦å‚™ç”¨è·¯å¾‘
if(NOT CORE_MQTT_SOURCES)
    file(GLOB CORE_MQTT_SOURCES
        "${AWS_IOT_SDK_ROOT}/source/coreMQTT/*.c"
        "${AWS_IOT_SDK_ROOT}/coreMQTT/source/*.c"
    )
endif()

if(NOT CORE_JSON_SOURCES)
    file(GLOB CORE_JSON_SOURCES
        "${AWS_IOT_SDK_ROOT}/source/coreJSON/*.c"
        "${AWS_IOT_SDK_ROOT}/coreJSON/source/*.c"
    )
endif()

# Transport æºæ–‡ä»¶ - æª¢æŸ¥å¤šå€‹å¯èƒ½è·¯å¾‘ (ä¿æŒå®Œå…¨ä¸è®Š)
set(TRANSPORT_SOURCES)
foreach(TRANSPORT_PATH
    "${AWS_IOT_SDK_ROOT}/platform/posix/transport/src/openssl_posix.c"
    "${AWS_IOT_SDK_ROOT}/demos/network_manager/openssl_posix.c"
    "${AWS_IOT_SDK_ROOT}/source/openssl_posix.c"
)
    if(EXISTS ${TRANSPORT_PATH})
        list(APPEND TRANSPORT_SOURCES ${TRANSPORT_PATH})
        break()
    endif()
endforeach()

foreach(SOCKET_PATH
    "${AWS_IOT_SDK_ROOT}/platform/posix/transport/src/sockets_posix.c"
    "${AWS_IOT_SDK_ROOT}/demos/network_manager/sockets_posix.c"
    "${AWS_IOT_SDK_ROOT}/source/sockets_posix.c"
)
    if(EXISTS ${SOCKET_PATH})
        list(APPEND TRANSPORT_SOURCES ${SOCKET_PATH})
        break()
    endif()
endforeach()

# Clock æºæ–‡ä»¶ - æª¢æŸ¥å¤šå€‹å¯èƒ½è·¯å¾‘ (ä¿æŒå®Œå…¨ä¸è®Š)
set(CLOCK_SOURCES)
foreach(CLOCK_PATH
    "${AWS_IOT_SDK_ROOT}/platform/posix/clock_posix.c"
    "${AWS_IOT_SDK_ROOT}/platform/posix/clock/clock_posix.c"
    "${AWS_IOT_SDK_ROOT}/demos/clock_posix.c"
    "${AWS_IOT_SDK_ROOT}/source/clock_posix.c"
)
    if(EXISTS ${CLOCK_PATH})
        list(APPEND CLOCK_SOURCES ${CLOCK_PATH})
        break()
    endif()
endforeach()

# æª¢æŸ¥æ‰€æœ‰å¿…è¦çš„æºæ–‡ä»¶æ˜¯å¦æ‰¾åˆ° (ä¿æŒå®Œå…¨ä¸è®Š)
if(NOT CORE_MQTT_SOURCES)
    message(FATAL_ERROR "âŒ coreMQTT sources not found in AWS IoT SDK")
endif()

if(NOT CORE_JSON_SOURCES)
    message(FATAL_ERROR "âŒ coreJSON sources not found in AWS IoT SDK")
endif()

if(NOT TRANSPORT_SOURCES)
    message(FATAL_ERROR "âŒ Transport sources not found in AWS IoT SDK")
endif()

if(NOT CLOCK_SOURCES)
    message(FATAL_ERROR "âŒ Clock sources not found in AWS IoT SDK")
endif()

# DMS Client æºæ–‡ä»¶ - æ–°å¢ DMS API å®¢æˆ¶ç«¯ (ä¿æŒåŸæœ‰)
set(DMS_CLIENT_SOURCES
    src/dms_client.c
    src/dms_api_client.c
    src/dms_log.c
    src/dms_config.c
    src/dms_aws_iot.c
    src/dms_shadow.c
    src/dms_command.c
    src/dms_reconnect.c
)

# å¦‚æœ BCML å•Ÿç”¨ï¼ŒåŠ å…¥é©é…å™¨
if(BCML_ENABLED)
    list(APPEND DMS_CLIENT_SOURCES src/bcml_adapter.c)
    message(STATUS "âœ… BCML adapter included in build")
endif()

# é¡¯ç¤ºæ‰¾åˆ°çš„æª”æ¡ˆæ•¸é‡ (ä¿æŒåŸæœ‰)
list(LENGTH CORE_MQTT_SOURCES mqtt_count)
list(LENGTH CORE_JSON_SOURCES json_count)
list(LENGTH TRANSPORT_SOURCES transport_count)
list(LENGTH CLOCK_SOURCES clock_count)

message(STATUS "Found ${mqtt_count} MQTT source files")
message(STATUS "Found ${json_count} JSON source files")
message(STATUS "Found ${transport_count} transport source files")
message(STATUS "Found ${clock_count} clock source files")

# å‰µå»ºåŸ·è¡Œæª” (ä¿æŒåŸæœ‰)
add_executable(dms-client
    ${DMS_CLIENT_SOURCES}
    ${CORE_MQTT_SOURCES}
    ${CORE_JSON_SOURCES}
    ${TRANSPORT_SOURCES}
    ${CLOCK_SOURCES}
)

# å°‹æ‰¾ä¸¦é€£çµ OpenSSL å’Œ libcurl (ä¿æŒåŸæœ‰)
find_package(PkgConfig REQUIRED)
pkg_check_modules(OPENSSL REQUIRED openssl)
pkg_check_modules(CURL REQUIRED libcurl)

target_link_libraries(dms-client
    ${OPENSSL_LIBRARIES}
    ${CURL_LIBRARIES}
    pthread
    rt
)

# å¦‚æœ BCML å•Ÿç”¨ï¼Œé€£çµ BCML ç›¸é—œåº«
if(BCML_ENABLED)
    target_link_libraries(dms-client ${BCML_LIB})
    target_link_libraries(dms-client cjson)  # OpenWrt cJSON å¥—ä»¶
    target_link_libraries(dms-client uci)    # OpenWrt UCI å¥—ä»¶
    message(STATUS "ğŸ”— BCML middleware libraries linked")
endif()

# ç·¨è­¯å®šç¾© (ä¿æŒåŸæœ‰ + ä¿®æ­£)
target_compile_definitions(dms-client PRIVATE
    USE_OPENSSL=1
    LOGGING_LEVEL_DEBUG=1
    DMS_API_ENABLED=1
    DMS_AES_ENABLED=1
)

# å®‰è£è¦å‰‡ (ä¿æŒåŸæœ‰)
install(TARGETS dms-client DESTINATION bin)

# é¡¯ç¤ºé…ç½®æ‘˜è¦
message(STATUS "=== DMS Client Configuration Summary ===")
message(STATUS "AWS IoT SDK: ${AWS_IOT_SDK_ROOT}")
if(BCML_ENABLED)
    message(STATUS "BCML Middleware: ENABLED (${BCML_ROOT})")
    message(STATUS "BCML Library: ${BCML_LIB}")
else()
    message(STATUS "BCML Middleware: DISABLED")
endif()
message(STATUS "Build Type: ${CMAKE_BUILD_TYPE}")
message(STATUS "========================================")
